<!DOCTYPE html>
<html>
  <head>
    <title>Solar Forecast</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Raleway"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <style>
      html,
      body,
      h1,
      h2,
      h3,
      h4,
      h5 {
        font-family: "Raleway", sans-serif;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      type="text/JavaScript"
      src=" https://MomentJS.com/downloads/moment.js"
    ></script>
  </head>
  <body class="w3-light-grey">
    <!-- Top container -->
    <div class="w3-bar w3-top w3-black w3-large" style="z-index: 4">
      <button
        class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey"
        onclick="w3_open();"
      >
        <i class="fa fa-bars"></i>  Menu
      </button>
      <span class="w3-bar-item w3-right">Logo</span>
    </div>

    <!-- Sidebar/menu -->
    <nav
      class="w3-sidebar w3-collapse w3-white w3-animate-left"
      style="z-index: 3; width: 300px"
      id="mySidebar"
    >
      <br />
      <div class="w3-container">
        <h5>Dashboard</h5>
      </div>
      <div class="w3-bar-block">
        <a
          href="#"
          class="w3-bar-item w3-button w3-padding-16 w3-hide-large w3-dark-grey w3-hover-black"
          onclick="w3_close()"
          title="close menu"
          ><i class="fa fa-remove fa-fw"></i>  Close Menu</a
        >
        <a href="index.html class="w3-bar-item w3-button w3-padding"
          ><i class="fa fa-sun-o fa-fw"></i>  Overview</a
        >
        <a href="advanced.html class="w3-bar-item w3-button w3-padding w3-blue"
          ><i class="fa fa-eye fa-fw"></i>  Advanced</a
        >
        <a href="settings.html" class="w3-bar-item w3-button w3-padding"
          ><i class="fa fa-cog fa-fw"></i>  Settings</a
        ><br /><br />
      </div>
    </nav>

    <!-- Overlay effect when opening sidebar on small screens -->
    <div
      class="w3-overlay w3-hide-large w3-animate-opacity"
      onclick="w3_close()"
      style="cursor: pointer"
      title="close side menu"
      id="myOverlay"
    ></div>

    <!-- !PAGE CONTENT! -->
    <div class="w3-main" style="margin-left: 300px; margin-top: 43px">
      <!-- Header -->
      <header class="w3-container" style="padding-top: 22px">
        <h5>
          <b>API Response</b>
        </h5>
      </header>
      <div class="w3-panel">
        <div class="w3-row-padding" style="margin: 0 -16px">
          <div class="w3-twothird">            
            <pre id="textresults"></pre>
          </div>
          <div class="w3-third"></div>
        </div>
      </div>
      <hr />
      <!-- Footer -->
      <footer class="w3-container w3-padding-16 w3-light-grey">
        <h4>FOOTER</h4>
        <p>
          Powered by
          <a href="https://www.w3schools.com/w3css/default.asp" target="_blank"
            >w3.css</a
          >
        </p>
      </footer>

      <!-- End page content -->
    </div>

    <script>
      // Get the Sidebar
      var mySidebar = document.getElementById("mySidebar");

      // Get the DIV with overlay effect
      var overlayBg = document.getElementById("myOverlay");

      // Toggle between showing and hiding the sidebar, and add overlay effect
      function w3_open() {
        if (mySidebar.style.display === "block") {
          mySidebar.style.display = "none";
          overlayBg.style.display = "none";
        } else {
          mySidebar.style.display = "block";
          overlayBg.style.display = "block";
        }
      }

      // Close the sidebar with the close button
      function w3_close() {
        mySidebar.style.display = "none";
        overlayBg.style.display = "none";
      }



      var lastUpdate;

      const baseUrl = "data.json"; //"https://api.forecast.solar/estimate/{{lat}}/{{lon}}/0/0/0.75";

      async function getLocation() {
        if (navigator.geolocation) {
          const coordinates = await getCoordinates();
          await showForecast(coordinates);
        } else {
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }

      function getCoordinates() {
        return;
        return new Promise(function (resolve, reject) {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
      }

      async function showForecast(position) {
        // x.innerHTML = "Latitude: " + position.coords.latitude +
        // "<br>Longitude: " + position.coords.longitude;
        const forecast = await getForecast(position);

        const dataset = getDataset(forecast);
        console.log(dataset);
        createChart(dataset);
        createTextResults(forecast);
      }
      async function createTextResults(forecast) {
        console.log(JSON.stringify(forecast, undefined, 2));
        // textResults.textContent = JSON.stringify(forecast, undefined, 2);

      }

      async function getapi(url) {
        // Storing response
        // const response = await fetch(url);
        // // Storing data in form of JSON
        // var data = await response.json();
        // console.log(data);
        //   if (response) {
        //     console.log("data here");
        //   }
      }

      async function getForecast(position) {
        const url = baseUrl;
        // .replaceAll("{{lat}}", position.coords.latitude)
        // .replaceAll("{{lon}}", position.coords.longitude);
        console.log(url);
        try {
          const response = await fetch(url);
          // // console.log(response);
          // // console.log();
          const result = await response.json();
          if (result.result) {
            lastUpdate = moment();
            localStorage.setItem('lastUpdate', lastUpdate.toString());
            localStorage.setItem('forecast', JSON.stringify(result));
            return result.result;
          }
        } catch (error) {
          console.error(error);
        }
        console.log('falling back to last response');
        lastUpdate = moment(localStorage.getItem(lastUpdate) || moment());
        return JSON.parse(localStorage.getItem('forecast')).result;
      }

      function createChart(dataset) {
        const config = {
          type: "line",
          data: {
            // labels: ['Jan', 'Feb'],
            datasets: [
              {
                label: "Watt Hours",
                data: dataset,
                parsing: {
                  yAxisKey: "watt_hours",
                },
                borderColor: "#0fb4d4",
                // pointRadius: "10",
                // pointBackgroundColor: "#945200",
                // pointBorderColor: "#ff9300",
                pointHoverBackgroundColor: "#ff9300",
                pointHoverBorderColor: "#945200",
              },
              {
                label: "Watts",
                data: dataset,
                parsing: {
                  yAxisKey: "watts",
                },
                borderColor: "#ffa3e6",
                // pointRadius: "10",
                // pointBackgroundColor: "#945200",
                // pointBorderColor: "#ff9300",
                pointHoverBackgroundColor: "#ff9300",
                pointHoverBorderColor: "#945200",
              },
            ],
          },
          options: {
            interaction: {
              mode: "nearest",
              axis: "x",
              intersect: false,
              // Overrides the global setting
              // mode: "index",
            },
            scales: {
              x: {
                ticks: {
                  // Include a dollar sign in the ticks
                  callback: function (val, index, ticks) {
                    return moment(this.getLabelForValue(val)).format(
                      "ddd DD/MM HH:mm"
                    );
                  },
                },
              },
            },
          },
        };
        const myChart = new Chart(document.getElementById("myChart"), config);
      }

      function getDataset(data) {
        return Object.keys(data.watts).map((ts) => ({
          x: moment(ts).format("LLLL"),
          watts: data.watts[ts],
          watt_hours: data.watt_hours[ts],
        }));
      }
      getLocation();
    </script>
  </body>
</html>
